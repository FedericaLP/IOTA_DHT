<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>FOAM API Example - Mapbox.GL</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/latlon-geohash@1.1.0/latlon-geohash.min.js"></script>
    <!-- Load the `mapbox-gl-geocoder` plugin. -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
        type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    <title>API Demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {

            height: 700px;
        }
    </style>
</head>

<body>
    <div id='map'></div>

    <button id="mybtn" onclick="loadPoints()">Load Points</button>
    <script>

        mapboxgl.accessToken = 'pk.eyJ1IjoiZmVkZXJpY2EwOTYiLCJhIjoiY2tudTE5YXdsMDhmZzJva2dyem9tcHdvMSJ9.YuPuUQEVwZymjH6oqiLABA';

        const FOAM_PENDING_COLOR = "#2E7CE6";
        const FOAM_VERIFIED_COLOR = "#26AB5F";
        const FOAM_CHALLENGED_COLOR = "#F48068";
        const FOAM_REMOVED_COLOR = "#FF0000";



        // get bounding box: http://bboxfinder.com
        let mapBounds = [11.279440, 44.473297, 11.409817, 44.517501];//Southwest corner, Northeast corner

        let url = 'https://map-api-direct.foam.space:443/poi/map?swLng=' + mapBounds[0] + '&swLat=' + mapBounds[2] + '&neLng=' + mapBounds[1] + '&neLat=' + mapBounds[3];

        // let basemap = 'basic';
        // let basemap = 'streets';
        // let basemap = 'bright';
        // let basemap = 'light';
        let basemap = 'dark';
        // let basemap = 'satellite';

        // https://www.mapbox.com/api-documentation/#styles
        let map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/' + basemap + '-v9',
            center: [11.344628, 44.495403],
            zoom: 13
        });

        mapboxgl.accessToken = 'pk.eyJ1IjoiZmVkZXJpY2EwOTYiLCJhIjoiY2tudTE5YXdsMDhmZzJva2dyem9tcHdvMSJ9.YuPuUQEVwZymjH6oqiLABA';

        function loadPoints() {
            axios.get(url)
                .then((response) => {

                    let data = response.data;
                    console.log(data)

                    let features = [];

                    for (beacon in data) {

                        //decode the beaconGeoHash value to lat, lon
                        let decodedLatLng = Geohash.decode(data[beacon].geohash);


                        feature = {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [decodedLatLng.lon, decodedLatLng.lat]
                            },
                            properties: {
                                beaconTransactionHash: data[beacon].listingHash,
                                beaconName: data[beacon].name,
                                beaconGeohash: data[beacon].geohash,
                                beaconBeaconAddress: data[beacon].owner,
                                beaconCreatedAt: data[beacon].state.createdAt,
                                beaconDeposit: data[beacon].state.deposit,
                                beaconStatus: data[beacon].state.status.type,
                                beaconColor: getPointColor(data[beacon].state.status.type)
                            }
                        };

                        features.push(feature);
                    }

                    let geojson = {
                        type: 'FeatureCollection',
                        features: features
                    };

                    map.addSource('data', {
                        type: 'geojson',
                        data: geojson
                    });

                    map.addLayer({
                        id: 'points',
                        source: 'data',
                        type: 'circle',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': ['get', 'beaconColor']
                        }
                    })
                },
                    (error) => {
                        let status = error.response.status
                    }
                );
        }



        function getPointColor(state) {

            if (state) {
                if (state === "applied") { return FOAM_PENDING_COLOR }
                else if (state === "listing") { return FOAM_VERIFIED_COLOR }
                else if (state === "challenged") { return FOAM_CHALLENGED_COLOR }
            } else {
                return FOAM_REMOVED_COLOR
            }
        }

        // Add the control to the map.
        map.addControl(
            new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl
            })
        );


        // When a click event occurs on a feature in the places layer, open a popup at the
        // location of the feature, with description HTML from its properties.
        map.on('click', 'points', function (e) {
            console.log("popoup");
            var coordinates = e.features[0].geometry.coordinates.slice();
            var beaconBeaconAddress = e.features[0].properties.beaconBeaconAddress;
            var properties = e.features[0].properties

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                // .setHTML('<strong>' + JSON.stringify(properties, null, 4) + '</strong>')
                .setHTML('<strong>' + printObject(properties) + '</strong>')
                .addTo(map);
        });

        //funzione per print popup
        
        function printObject(o) {
            var out = '';
            for (var p in o) {
                out += p + ': ' + o[p] + '\n';
            }
            return out;
        }



    </script>
</body>

</html>